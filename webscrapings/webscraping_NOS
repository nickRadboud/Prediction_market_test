import requests
from bs4 import BeautifulSoup
import schedule
import time
import datetime
import telebot
from telethon.sync import TelegramClient
from telethon.tl.types import InputPeerUser, InputPeerChannel
from telethon import TelegramClient, sync, events

 
api_id = 35931157
api_hash = 'cedb6ed5526436faeb08f890f0195b07'
token = '8595672430:AAHVaIuUAQSAyyyU3PM_HyP_SZ_473Lm_pY'
bot_username = 'NicksNewsBot'

phone_number = '+31653908138'

URL = "https://nos.nl/nieuws/laatste"
printed_headlines = set()

just_started = True
chat_id = 7317609576

bot = telebot.TeleBot(token)

def get_headlines():
    global just_started

    response = requests.get(URL, timeout=30)
    if response.status_code != 200:
        print("Failed to retrieve the webpage.")
        return
    
    soup = BeautifulSoup(response.content, "html.parser")
    headlines = soup.find_all("h2")
    for headline in headlines:
        headline_text = headline.get_text().strip().lower()
        if headline_text and headline_text not in printed_headlines:
            printed_headlines.add(headline_text)
            print("TITLE: ", headline_text)
            # Get the accompanying p tag below the h2
            p_tag = headline.find_next("p")
            if p_tag:
                p_text = p_tag.get_text().strip()
                print("DESCRIPTION: ", p_text)
            print()  # blank line for readability
            if not just_started:
                print("===================================================")
                send_telegram_message(headline_text, p_text)
    if just_started:
        send_telegram_message("start", "start")
    just_started = False

def send_telegram_message(title, description, link):  
    global chat_id
    
    try:
        message = f"<b>{title}</b>\n\n{description}\n\n{link}"
        bot.send_message(chat_id, message, parse_mode='HTML')
        print(f"Message sent successfully")
    except Exception as e:
        print(f"Error sending message: {e}")


def run():
    schedule.every(0.1).minutes.do(get_headlines)
    print("Scheduler started. Running every 6 seconds.")
    while True:
        schedule.run_pending()
        time.sleep(1)

if __name__ == "__main__":
    run()